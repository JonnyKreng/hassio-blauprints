blueprint:
  name: Update Sonoff TRV Valve 
  description: >
    Adjusts the valve closing/opening degrees based on a PID controller output,
    the buildings efficiency and indoor and outdoor temepature readings. Using 
    sonoff trvs and https://github.com/bvweerd/simple_pid_controller together 
    with his automation should result in a really efficent heating solution.
  domain: automation
  input:
    thermostat_sensor:
      name: Thermostat PID output
      description: Sensor that provides the PID controller output
      selector:
        entity:
          domain: sensor
    indoor_meter:
      name: Indoor meter
      description: Indoor temperature
      selector:
        entity:
          domain: sensor
    outdoor_meter:
      name: Outdoor meter
      description: Outdoor temperature
      selector:
        entity:
          domain: sensor
    building_efficiency:
      name: Building efficiency factor
      description: > 
        Input number that represents the buildingâ€™s efficiency. Good 
        insulated building have a value around 0.6. Use a heigher number
        for bad insulation.
      selector:
        entity:
          domain: input_number
    valve_closing:
      name: Valve closing degree number
      description: Number entity that controls the valve closing degree
      selector:
        entity:
          domain: number
    valve_opening:
      name: Valve opening degree number
      description: Number entity that controls the valve opening degree
      selector:
        entity:
          domain: number

trigger:
  - platform: state
    entity_id: !input thermostat_sensor
  - platform: state
    entity_id: !input indoor_meter
  - platform: state
    entity_id: !input outdoor_meter

variables:
  thermostat_sensor: !input 'thermostat_sensor'
  building_efficiency: !input 'building_efficiency'
  indoor_meter: !input 'indoor_meter'
  outdoor_meter: !input 'outdoor_meter'
  valve_value: >-
    {{
      (states(thermostat_sensor) | float) +
      (states(building_efficiency) | float) *
      ((states(indoor_meter) | float) -
       (states(outdoor_meter) | float) | abs)
    }}

action:
  - service: number.set_value
    target:
      entity_id: !input valve_closing
    data:
      value: "{{ 100.0 - valve_value | float }}"

  - service: number.set_value
    target:
      entity_id: !input valve_opening
    data:
      value: >-
        {% set v = valve_value | float + 5 %}
        {{ 100 if v > 100 else v }}

mode: single